<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/audio-processors/ffmpeg-processor.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/audio-processors/ffmpeg-processor.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const ffmpeg = require('fluent-ffmpeg');
const ffmpegPath = require('ffmpeg-static');
const { PassThrough } = require('stream');

// Set the path to the bundled FFmpeg binary once
ffmpeg.setFfmpegPath(ffmpegPath);

/**
 * Base class for audio processors that use FFmpeg.
 * This class handles the common logic for starting, stopping,
 * and processing audio from an FFmpeg process.
 */
class FfmpegProcessor {
  /**
   * @param {string} sourceUrl - The input source URL or path for FFmpeg.
   * @param {Object} options - Configuration options.
   * @param {Function} [options.onAudio] - Callback for when audio data is received.
   * @param {Function} [options.onError] - Callback for when an error occurs.
   */
  constructor(sourceUrl, options = {}) {
    if (this.constructor === FfmpegProcessor) {
      throw new Error("FfmpegProcessor is an abstract class and cannot be instantiated directly.");
    }
    this.sourceUrl = sourceUrl;
    this.options = options;
    this.ffmpegProcess = null;
    this.isProcessing = false;
    this.onAudioCallback = options.onAudio || (() => {});
    this.onErrorCallback = options.onError || (() => {});
  }

  /**
   * Provides the specific FFmpeg input options for the subclass.
   * This method must be implemented by subclasses.
   * @returns {string[]} An array of FFmpeg input option strings.
   * @protected
   */
  _getInputOptions() {
    // Default implementation returns an empty array.
    // Subclasses should override this to provide specific options.
    return [];
  }

  /**
   * Starts processing the stream.
   * @returns {Promise&lt;void>} A promise that resolves when the FFmpeg process has started.
   */
  start() {
    return new Promise((resolve, reject) => {
      if (this.isProcessing) {
        return resolve();
      }
      this.isProcessing = true;

      try {
        const audioStream = new PassThrough();
        const inputOptions = this._getInputOptions();


        
        this.ffmpegProcess = ffmpeg(this.sourceUrl)
          .inputOptions(inputOptions)
          .noVideo()
          .audioChannels(1)
          .audioFrequency(16000)
          .format('f32le') // 32-bit float PCM for whisper
          .on('start', (commandLine) => {
    
            resolve();
          })
          .on('error', (err) => {
            this.isProcessing = false;
            this.onErrorCallback(err);
            reject(err);
          })
          .on('end', () => {
            this.isProcessing = false;
          });

        this.ffmpegProcess.pipe(audioStream, { end: true });

        audioStream.on('data', (chunk) => {
          const audioData = new Float32Array(new Uint8Array(chunk).buffer);
          this.onAudioCallback(audioData);
        });

      } catch (error) {
        this.isProcessing = false;
        this.onErrorCallback(error);
        reject(error);
      }
    });
  }

  /**
   * Stops the FFmpeg process.
   */
  stop() {
    if (this.ffmpegProcess) {
      this.ffmpegProcess.kill('SIGTERM');
      this.ffmpegProcess = null;
    }
    this.isProcessing = false;
  }
}

module.exports = FfmpegProcessor; </code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="FfmpegProcessor.html">FfmpegProcessor</a></li><li><a href="FileProcessor.html">FileProcessor</a></li><li><a href="HlsProcessor.html">HlsProcessor</a></li><li><a href="MaestraClient.html">MaestraClient</a></li><li><a href="MicrophoneProcessor.html">MicrophoneProcessor</a></li><li><a href="RtmpsProcessor.html">RtmpsProcessor</a></li><li><a href="RtspProcessor.html">RtspProcessor</a></li><li><a href="SrtProcessor.html">SrtProcessor</a></li><li><a href="StreamInputProcessor.html">StreamInputProcessor</a></li><li><a href="WebSocketClient.html">WebSocketClient</a></li></ul><h3>Global</h3><ul><li><a href="global.html#main">main</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Sep 12 2025 16:17:29 GMT+0300 (GMT+03:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
